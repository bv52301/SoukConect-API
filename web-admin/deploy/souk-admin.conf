server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;
    root /var/www/souk-admin;
    index index.html;
    client_max_body_size 20m;

    # DNS resolver required when proxy_pass uses variables
    # AWS VPC DNS first, then public resolvers; disable IPv6 for simplicity
    resolver 169.254.169.253 8.8.8.8 1.1.1.1 valid=300s ipv6=off;
    resolver_timeout 5s;

    # Single Page App fallback
    location / { try_files $uri $uri/ /index.html; }

    # Ensure API-served uploads and preview endpoints are proxied BEFORE static asset rules
    # Media previews and uploaded files are served by the API under /uploads and /preview
    location ^~ /uploads/ {
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_pass $products_origin; # default is $api_origin; override via api.conf if split
    }

    location ^~ /preview/ {
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_pass $products_origin;
    }

    # Static asset caching (Vite hashed filenames are immutable)
    location ~* \.(?:js|css|png|jpg|jpeg|gif|ico|svg|woff2?)$ {
        expires 7d;
        add_header Cache-Control "public, max-age=604800, immutable";
        try_files $uri =404;
    }

    # Bring in runtime API origin variables
    include /etc/souk-admin/api.conf;

    # Optional: drop additional endpoint proxies here without editing this file
    # Create files under /etc/souk-admin/routes.d/ containing `location` blocks
    # e.g., /etc/souk-admin/routes.d/orders.conf with a regex location to proxy /orders
    include /etc/souk-admin/routes.d/*.conf;

    # Proxy API paths to their configured origins (supports combined or split services)
    location ~ ^/vendors(/|$) {
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_pass $vendors_origin;
    }
    location ~ ^/products(/|$) {
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_pass $products_origin;
    }
    location ~ ^/cuisines(/|$) {
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_pass $cuisines_origin;
    }
    location ~ ^/customers(/|$) {
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_pass $customers_origin;
    }

    # Catch-all API proxy for any other top-level paths (excluding assets)
    # Routes to the default combined origin so you can add endpoints without code changes.
    location ~ ^/(?!assets/)[A-Za-z0-9_-]+(/|$) {
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_pass $api_origin;
    }
}
